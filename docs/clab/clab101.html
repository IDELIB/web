<HTML>
<HEAD>
<TITLE>CLab_10-トランザクション処理</TITLE>
</HEAD>
<BODY BGCOLOR="#FFFFFF" TEXT="#000000">
<CENTER>
<TABLE BORDER=0" WIDTH="600" BGCOLOR="#FEFBDA">
<TR>
<TD>
<TABLE BORDER=0" WIDTH="600">
<TR>
<TD BGCOLOR="#800040" WIDTH="10%" ALIGN="CENTER">
<FONT SIZE=2 COLOR="#FFFFFF"><B>第10章</B></FONT>
</TD>
<TD BGCOLOR="000000" WIDTH="75%">
<FONT SIZE=4 COLOR ="#FFFFFF"><B>　コミットメントサイクル </B></FONT>
<BR>
</TD>
<TD BGCOLOR="000000" WIDTH="15%">
<FONT SIZE=1 COLOR ="#FFFFFF"><B>RPGプログラマーの為のＣ言語講座</B></FONT>
</TD>
</TR>
</TABLE>
</TD>
</TR>
<TR>
<TD ALIGN="CENTER">
<TABLE BORDER=0" WIDTH="570">
<TR>
<TD>
<FONT SIZE=2><B>

トランザクション処理というとＳＱＬが代表的ですが、ここでは、まず、
ＯＳ／４００が基本機能として持っているトランザクション処理について説明し、
従来のＲＰＧがどのようにして動作するかを確認した後に、ＳＱＬの説明に入りたいと思います。

ところで、トランザクション処理とはどんな処理をいうのでしょうか？

もちろん、きちんとした定義はありますが、あえて誤解をおそれず簡単にいってしまうと

<FONT COLOR="#804040"><H2>データベースへの一連の更新が、全てＯＫか、全てダメか、どちらかしかないようにする処理</H2></FONT>

という事になるでしょう。
<H3>【データベースとは】</H3>
ＡＳ／４００のユーザーは、データベースという意味を、しばしば、物理ファイル，論理ファイルを指して
使用されているようです。
<BR>おそらく、ＡＳ／４００はＤＢ２／４００をＯＳの中に組み込んでいるため、
<FONT COLOR="#004080">（ DB2/400 という言い方もあとからついた名称で、当初はＲＤＢに名前すら付いていませんでした）</FONT>
ユーザーがＤＢＭＳの存在をほとんど意識しないでＲＤＢを使用出来ることに起因するのでしょう。
<BR>ＯＳ／４００のIPLが終われば、なんにもしないでいきなりファイル（テーブル）を作成できるのですから
すごいことですよね。

<P>他の DBMS はインストール／構成と言った作業が必要なので、嫌でも DBMS 自体の管理が必要になります。
<BR>という訳で、世間一般では、<FONT COLOR="#0080ff">データベースというと、ＤＢＭＳを指していることが多いでしょう。</FONT>

<H3>【一連の更新とは】</H3>

対象となる更新には、
<UL>
<LI>複数のファイルに対して行う更新、
<LI>同じファイル（テーブル）に対して行う、複数回の更新（READ/WRITE/UPDATE/DELETE)
</UL>
などが考えられます。
<P>プログラム（ＪＯＢ）行う上記の更新は、複数の READ/WRITE/UPDATE/DELTE がある同じパターンで繰り返されるはずです。

<BR>たとえば、販売システムなどで<BR>
<FONT COLOR="#004080">「商品マスターをCHAINして整合性チェックしたあとに、売上ファイルに明細をWRITEして、在庫数量をUPDATEして、
得意先の売掛金をUPDATEする」</FONT>
<BR>といった一連の処理は、ＰＧＭは分割されるかもしれませんが、売上計上処理毎には同じパターンの繰り返しになるはずです。

<P><FONT COLOR="#0080ff">この一連の繰り返しの範囲で、全てをＯＫとするか (COMMIT)全てをダメにするか(ROLLBACK)どちらかしかない
処理が、トランザクション処理と言えるでしょう。（勝手な独断？）
</FONT>

<H3>【コミットメントサイクル】</H3>

<P>前置きが長くなってしまいましたが、<FONT COLOR="#ff0080">「データベースへの一連の更新」をトランザクション（または作業単位）</FONT>といいます。
<P>トランザクションを、<FONT COLOR="#ff0080">「全てＯＫ」にすることが COMMIT</FONT> で、
<FONT COLOR="#ff0080">「全てダメ」にすることがROLLBACK</FONT>です。
<BR>また、COMMIT/ROLLBACKから次のCOMMIT/ROLLBACKまでを<FONT COLOR="#ff0080">コミットメントサイクル</FONT>といいます。
<P>コミットメントサイクルで、COMMIT/ROLLBACKの制御を行うことを、<FONT COLOR="#ff0080">コミットメントコントロール</FONT>といいます。

<H3>【ＡＳ／４００でのコミットメントコントロール】</H3>

ＳＱＬ以外のプログラムは、JOBの中でSTRCMTCTLコマンドを発行して、コミットメント制御を開始します。

<H5>STRCMTCTLコマンドのパラメーターの詳細はマニュアルまたはヘルプを参照して下さい。</H5>

<P>ここでは、実際のコミットメント制御の動作にかかわるLCKLVLとCMTSCOPEを説明します。

<P>マニュアルより抜粋
<PRE>
LCKLVL
    開始されるコミットメント定義の際に起こるレコード・ロックの省略時レベル
    を指定します。
 
    *CHG:  更新のために読み込まれたすべてのレコード (コミットメント制御下
    でオープンされたファイル) がロックされます。更新、追加、または削除され
    たレコードは、変換がコミットされるか、あるいはロールバックされるまでロ
    ックされたままです。更新の目的でアクセスされ、更新されずに解放されたレ
    コードはアンロックされます。
 
    *CS:  コミットメント制御下でオープンされたファイルに対してアクセスする
    すべてのレコードがロックされます。更新または削除されないレコードは、別
    のレコードがアクセスされるまでの間だけロックされます。更新、追加、また
    は削除されるレコードは、トランザクションのコミットまたはロール・バック
    が終るまではロックされます。
 
    *ALL:  コミットメント制御下でオープンされたファイルに対してアクセスす
    るすべてのレコードは、そのトランザクションがコミットされるかまたはロー
    ルバックされるまでロックされます。

CMTSCOPE
    開始するコミットメント定義の範囲を指定します。
 
    *ACTGRP:  活性化グループ・レベル・コミットメント定義が、コマンドを出す
    プログラムに関連付けられる活性化グループに対して開始されます。
 
    *JOB:  ジョブ・レベル・コミットメント定義が、ジョブに対して開始されま
    す。
</PRE>

<H3>【関連コマンド】</H3>

コミットメント制御
<UL>
<LI>STRCMTCTL コミットメント制御開始
<LI>ENDCMTCTL コミットメント制御終了
<LI>WRKCMTDFN コミットメント定義処理
</UL>
ジャーナル関連
<UL>
<LI>CRTJRNRCV　ジャーナルレシーバーの作成
<LI>CRTJRN　　ジャーナルの作成　
<LI>STRJRNPF　物理ファイルにジャーナル開始
</UL>
コミット／ロールバック
<UL>
<LI>COMMIT/ROLLBACK ＣＬコマンド
<LI>COMMIT/ROOLBACK ＳＱＬコマンド
<LI>COMIT/ROLBK ＲＰＧコマンド（Ｆ仕様書にKCOMITが必要）
</UL>







</B>
</FONT>
</TD></TR>
</TABLE>

<HR>
</TD></TR>
</TABLE>

</BODY>
</HTML>

