<HTML>
<HEAD>
<TITLE>CLab_08-Ｃ仕様書</TITLE>
</HEAD>
<BODY BGCOLOR="#FFFFFF" TEXT="#000000">
<CENTER>
<TABLE BORDER=0" WIDTH="600" BGCOLOR="#FEFBDA">
<TR>
<TD>
<TABLE BORDER=0" WIDTH="600">
<TR>
<TD BGCOLOR="#800040" WIDTH="10%" ALIGN="CENTER">
<FONT SIZE=2 COLOR="#FFFFFF"><B>第８章</B></FONT>
</TD>
<TD BGCOLOR="000000" WIDTH="75%">
<FONT SIZE=4 COLOR ="#FFFFFF"><B>　サブルーチン</B></FONT>
<BR>
</TD>
<TD BGCOLOR="000000" WIDTH="15%">
<FONT SIZE=1 COLOR ="#FFFFFF"><B>RPGプログラマーの為のＣ言語講座</B></FONT>
</TD>
</TR>
</TABLE>
</TD>
</TR>
<TR>
<TD ALIGN="CENTER">
<TABLE BORDER=0" WIDTH="570">
<TR>
<TD>
<FONT SIZE=3>

<H2>サブルーチンの使い方</H2>

<B><P>サブルーチンの使い方についてＲＰＧとＣを比較して見ましょう！</B>

<P>ＲＰＧでのサブルーチンの使用法は以下の通りです。

<CENTER>
<TABLE BORDER=1 WIDTH="550" BGCOLOR="#E0FFDF" >
<TR>
<TD>
<PRE>
<FONT COLOR="#008000">
     H            Y/                                    1
     H*---------------------------------------------------------------*
     H* PROGRAM-ID    :    CSPEC1R                                    *
     H* REMARKS       :    サブルーチン                               *
     H* AUTHOR        :    Y.IDE                                      *
     H* DATE-WRITEN   :    1999/10/30                                 *
     H* VERSION       :    01.00 ORIGINAL                             *
     H*---------------------------------------------------------------*</FONT>
     C* メインルーチン
     C                     EXSR SUB#R1
     C                     EXSR SUB#R2
     C                     SETON                     LR
     C                     RETRN
     C* サブルーチン
     C*------------------------------------------------*
     C           SUB#R1    BEGSR
     C*------------------------------------------------*
     C           'SUB#R1'  DSPLY
     C                     ENDSR
     C*------------------------------------------------*
     C           SUB#R2    BEGSR
     C*------------------------------------------------*
     C           'SUB#R2'  DSPLY
     C                     ENDSR

</PRE>
</TD>
</TR>
</TABLE>
</CENTER>
<B>
<UL><PRE>
			EXSR サブルーチン名

サブルーチン名　	BEGSR

			ENDSR

</UL></PRE>

<P>サブルーチンの呼出しは EXSR で行いサブルーチンのコードは、
<BR>BEGSR 〜 ENDSR の間に記述し、メインルーチンの後ろにおきます。
</B>

<P>Ｃのサブルーチンの使用法は以下の通りです。
<CENTER>
<TABLE BORDER=1 WIDTH="550" BGCOLOR="#E0FFDF" >
<TR>
<TD>
<PRE>
<FONT COLOR="#008000">
/*---------------------------------------------------------------*/
/* PROGRAM-ID  : CSPEC1                                          */
/* REMARKS     : Ｃ仕様書サブルーチン                            */
/* AUTHOR      : Y.Ide                                           */
/* DATE-WRITEN : 1999/10/30                                      */
/* VERSION     : 01.00 ORIGINAL                                  */
/*---------------------------------------------------------------*/</FONT>

#include&LT;stdio.h&GT;
#include&LT;stdlib.h&GT;

<FONT COLOR="#0080ff">/* サブルーチン */</FONT>
void sub_r1(void){
  printf(" サブルーチン１ ??/n");
  return;
}

<FONT COLOR="#ff0080">/* プロトタイプ */</FONT>
void sub_r2(void);

<FONT COLOR="#0080ff">/* メインルーチン */</FONT>
int main(int argc, char *argv[]){
  sub_r1();
  sub_r2();
  exit(0);
}

<FONT COLOR="#ff0080">/* サブルーチン (mainの後ならプロトタイプが必要) */</FONT>
/*----------------------------------------*/
  void sub_r2(void){
/*----------------------------------------*/
    printf(" サブルーチン２ ??/n");
    return;
  }

</PRE>
</TD>
</TR>
</TABLE>
</CENTER>

<B><P>サブルーチンの呼出しは ルーチン名（Ｃでは通常サブルーチンとは言わず関数と呼びます）で行い
サブルーチンのコードは、｛　｝の間に記述し、<FONT COLOR="#ff0080">メインルーチンの前</FONT>におきます。
</B>

<B><P>メインルーチンの後ろに置く場合は（上記 sub_r2 )は、関数の戻り値と引数だけ記述した、
<FONT COLOR="#ff0080">プロトタイプ</FONT>をメインルーチンの前におきます。</B>
<BR>プロトタイプがない場合は、コンパイルのときに警告メッセージがでます。

<P>また、ＲＰＧの場合は、サブルーチンは必ず同じコードないに記述し、同時にコンパイルすることが必要ですが、
ILEでは、<B>モジュール別に分割して作成することが可能</B>です。

<P><B>上記の例では、</B><BR>
<PRE>
<FONT COLOR="#ff0080">/* サブルーチン (mainの後ならプロトタイプが必要) */</FONT>
/*----------------------------------------*/
  void sub_r2(void){
/*----------------------------------------*/
    printf(" サブルーチン２ ??/n");
    return;
  }
</PRE>
の部分は、別のモジュールとして作成し、後からバインドすることが可能です。

<P>また、上記のプログラムでは、<B>void sub_r2(void)</B> となっていますが、<B>void</B> というは、
型を持たないということを示します。

<B><BR>つまり、上記は、このサブルーチン（関数）には、引数として渡すパラメータも、戻り値として帰される値もないことを
表しています。</B>
<BR>ですから、呼出す場合は、
<UL>  <B>sub_r2();</B>
</UL>
となります。

<P>もし、<B>int sub_r2(void)</B> となっていた場合には、その呼び出しは、
<UL>  <B>rc = sub_r2();</B>
</UL>
となるでしょう。（rc は省略しても構いません）

<P>もし、<B>void sub_r2(int)</B> となっていた場合には、その呼び出しは、
<UL>  <B>sub_r2(rc);</B>
</UL>
となるでしょう。この場合の rc は必須です。

<BR>注意が必要なのは、Ｃの引数は値渡しなので、rc はサブルーチンには渡りますが、<FONT COLOR="#ff0080">呼出しもとのプログラムに
は戻ってきません。</FONT>
<BR>このことは、もしサブルーチン内部で、<B>rc</B> の値を変更したとしても、呼出しもとの <B>rc</B> の値には影響がない（変更が反映しない）ことを意味します。

<P><B>もし、サブルーチンの変更結果を戻す必要があるのなら</B>、戻り値とする、or 引数をポインターとして定義する or 
フィールドの有効範囲（スコープ）を main の外側に出す、ことが必要です。

<OL>
<LI><B>戻り値とする。以下のように記述します。</B>
<PRE>
int main(int argc, char *argv[]){
  int rc;
  rc = sub_r2();
}
/*----------------------------------------*/
  int  sub_r2(void){
/*----------------------------------------*/
    int rc;
	rc = 1;
    return rc;
  }
</PRE>

<LI><B>引数をポインターとして定義する</B>
<PRE>
int main(int argc, char *argv[]){
  int rc;
  sub_r2(&rc);
}
/*----------------------------------------*/
  void  sub_r2(int *rc_ptr){
/*----------------------------------------*/
	*rc_ptr = 1;
    return;
  }
</PRE>
ポインターをパラメータとして渡しているので、サブルーチンが変更するのは、main ルーチンのフィールドとなる。
<BR><H4>つまり、サブルーチンでの変更が反映することになります。</H4>

<LI><B>フィールドの有効範囲（スコープ）を main の外側に出す</B>

<FONT COLOR="#ff0080"><H5>（注）Ｃでのフィールドは、定義された｛｝の中でだけで有効です。
<BR>｛｝の外側で定義するとプログラム全体で有効となります。</H5></FONT>

<PRE>
int rc;

int main(int argc, char *argv[]){
  sub_r2();
}
/*----------------------------------------*/
  void  sub_r2(void){
/*----------------------------------------*/
	rc = 1;
    return;
  }
</PRE>
この例では、rcは　main の外側で定義されています、この場合、<B>rc</B> の有効範囲は以降全てのルーチン（関数）に
及びます。
<BR><H4>つまり、変更が反映することになります。</H4>

<H4>
<P>ＯＰＭ−ＲＰＧには、内部サブルーチンにパラメーターを渡すことができません。
<P>ＯＰＭ−ＲＰＧには、フィールドの有効範囲がありません。
<P>ＲＰＧでのフィールド定義は、プログラムのすべてのルーチンで有効です。
<P><FONT COLOR="#0080ff">つまり、この例が、ＯＰＭ−ＲＰＧのサブルーチン呼出しに一番近い呼出し方法となります。</FONT></H4>

</OL>
</B>

<HR>
</TD></TR>
</TABLE>

</TD></TR>
</TABLE>

</BODY>
</HTML>